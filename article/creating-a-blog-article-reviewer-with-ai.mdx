---
layout: post
title: "Creating a reviewer for article using OpenAI"
excerpt: ""
thumbnail_image: ../../static/images/blog/...
cover_image: ../../static/images/blog/...
authors:
  - thiery
tags:
---

At Marmelab, we write many blog articles that require reviewing and improvement.
AI models like ChatGPT are great for text improvement. What if we created an AI bot to review articles?
We create blog articles by opening pull requests on the blog repository. What if we used a GitHub action to review our articles using OpenAI?

The first step is to call OpenAI with the article content and the appropriate prompt. Integration with GitHub would be the next step.

Calling the OpenAI API is simple with the `openai` package. Just follow the README instructions.
Finding the right prompt was a significant challenge.

## The quest for the good prompt

I will not run you through all the different versions of the prompt, instead here is the lesson I learned:

### The AI loves to explain what it does

The AI being created as an agent loves to talk, but I just wanted the result. So the instruction `Do not explain what you are doing` is invaluable.

### The AI can generate JSON rather reliably if you ask correctly

You can have the AI format its response in JSON reliably, by providing a template.

```json
[
    {
        "comment": "<comment targeting one line>",
        "lineNumber": <line_number>,
        "suggestion": "<The text to replace the existing line with. Leave empty, when no suggestion is applicable, must be related to the comment>",
    }
]
```

Note it tends to wrap the result in a `\`\`\`json` tag, even when you tell it not to.

### The AI does not know how to count

At first, I passed the article directly and got back an array of comments. But the line numbers were wrong. They were often bigger than the size of the text.
The funny thing is that it was able to quote the line it targeted when asked to.
In the end, I added the line number at the start of every line. As is the case in the GitHub diff.
But even like this it still gets it wrong sometimes, albeit way more rarely.

### The AI result is random

It should be obvious, but I was still surprised by how the same prompt could yield vastly different results.

### The AI will want to do what you ask, even when there is nothing to do.

When you ask the AI to return an array of comments, it will do so even if there is nothing to improve. I had to specifically instruct it to return nothing if there were no suggestions.

The final prompt (for now)

```
Your task is to review pull requests on a technical blog. Instructions:
  - Do not explain what you're doing.
  - Provide the response in following JSON format, And return only the json:

  [
      {
          "comment": "<comment targeting one line>",
          "lineNumber": <line_number>,
          "suggestion": "<The text to replace the existing line with. Leave empty, when no suggestion is applicable, must be related to the comment>",
      }
  ]
  - returned result must only contains valid json
  - Propose change to text and code.
  - Fix typo, grammar and spelling
  - ensure short sentence
  - ensure one idea per sentence
  - simplify complex sentence.
  - No more than one comment per line
  - One comment can address several issues
  - Provide comments and suggestions ONLY if there is something to improve or fix, otherwise return an empty array.

  Git diff of the article to review:

\`\`\`diff
${diff}
\`\`\`
```

## Integrating with github API

To integrate with the GitHub API in a GitHub action I used [@octokit/rest](https://github.com/octokit/rest.js)
For what I wanted I needed to:

- retrieve the current pull request details
- retrieve the diff
- create the review

### Retrieving the current pull request details

To retrieve the pull request details in a GitHub actions context, you must first execute the `actions/checkout@v3` action.
Then using the GITHUB_EVENT_PATH environment variable, you can read the repository information with

```ts
const { repository, number } = JSON.parse(
  readFileSync(process.env.GITHUB_EVENT_PATH || "", "utf8")
);
return {
  owner: repository.owner.login,
  repo: repository.name,
  pull_number: number,
};
```

### Retrieving the diff

To retrieve the diff you can use `octokit.pulls.get`

```ts
const response = await octokit.pulls.get({
  owner,
  repo,
  pull_number,
  mediaType: { format: "diff" },
});
```

### creating the review

Finally, after you have retrieved the comments using OpenAi you can create a code review with:

```ts
await octokit.pulls.createReview({
  owner,
  repo,
  pull_number,
  comments,
  event: "COMMENT",
});
```

A GitHub comment is composed of a line, path, and body. I placed the comment and the suggestion in the body

```ts
body: `${item.comment}
\`\`\`suggestion
${item.suggestion}
\`\`\``;
```

Be careful not to keep any indentation as it could change the suggestion to a block quote.

## Conclusion

Here is the repository of the GitHub actions: [AI Article Reviewer](https://github.com/ThieryMichel/proof-reader-ai)
The action has been published (add a link once published) feel free to try it by following the README.
